# v1.3 – Immich Setup

## Objective
- Set up Immich, a self-hosted photo management platform, on the Ubuntu Server VM, fully integrated with the TrueNAS ZFS pool.
- Enable persistent storage for media
- Ensure consistent UID/GID mapping for NFS mounts
- Deploy supporting services (PostgreSQL and Redis) with persistence and automated backups

## Setup Overview
### Component	Details
- Service Host	Ubuntu Server VM (13GB RAM, 2 vCPU, 110GB disk)
- Storage Mount	TrueNAS NFS: /mnt/swimming_pool/immich/upload → Container: /usr/src/app/upload
- Containers	Immich Server, Web, Microservices, PostgreSQL, Redis
- UID/GID	3000:3001
- Orchestration	Docker Compose with healthchecks & dependency conditions
- ```UPLOAD_LOCATION=/usr/src/app/upload```
- Verified that uploads and thumbnails persist on the ZFS mirror pool
![Immich testfile ownership](https://github.com/w0lfx-standalone/somaniserver/blob/main/assets/ubuntu_immich_testfile-ownership.png)

## Database Handling

- Deployed PostgreSQL and Redis containers alongside Immich
- Mounted volumes for persistent database storage
- Configured automated database dumps for recovery
- Tested database restoration to ensure backups are functional

![Immich Database backup](https://github.com/w0lfx-standalone/somaniserver/blob/main/assets/ubuntu_immich_database-backup.png)

## Storage & Permissions

- Mounted the TrueNAS dataset via NFS to the Ubuntu Server VM:
- `TrueNAS: /mnt/swimming_pool/immich → Ubuntu: /mnt/immich_upload`
- Immich container maps the Ubuntu mount to:
  ![immich mounts](https://github.com/w0lfx-standalone/somaniserver/blob/main/assets/ubuntu_immich-folder-mount.png)
- Ensured UID/GID mapping (3000:3001) is consistent across TrueNAS and Ubuntu
![immich mounts](https://github.com/w0lfx-standalone/somaniserver/blob/main/assets/ubuntu_immich-database-mount.png)

- Applied POSIX ACLs so Immich can fully read/write files without permission issues
![Mount Ownership](https://github.com/w0lfx-standalone/somaniserver/blob/main/assets/ubuntu_immich_mount-ownership.png)

![Truenas Immich Ownership](https://github.com/w0lfx-standalone/somaniserver/blob/main/assets/truenas_immich-permission.png)
- Verified that uploads and thumbnails persist directly on the ZFS mirror pool, through the NFS mount

## Deployment Actions

- Pulled all Immich Docker images (Server, Web, Microservices)
- Deployed containers with restart: always
- Added healthchecks and dependency conditions to ensure Immich waits for Postgres and Redis readiness before startup
- Verified container logs for successful startup
`Tested photo uploads → confirmed files appear in ZFS pool`

![Immich docker](https://github.com/w0lfx-standalone/somaniserver/blob/main/assets/ubuntu_immich_docker-running.png)

## Verification & Testing

- Uploaded multiple photos → confirmed storage in /mnt/swimming_pool/immich/upload
- Checked UID/GID ownership → correct permissions applied
![Immich Uploads](https://github.com/w0lfx-standalone/somaniserver/blob/main/assets/ubuntu_immich-uploads.png)

- Stopped and restarted containers → data persisted
- Verified database dump scripts run correctly

## Reliability & Recovery

- Photo storage is on ZFS mirror → survives single disk failure
- Database dumps ensure data can be restored if needed
- VM or container reinstallation does not affect persistent storage, thanks to consistent UID/GID mapping

![Immich server-status](https://github.com/w0lfx-standalone/somaniserver/blob/main/assets/ubuntu_immich_server-seatus.png)

## Outcome

- Immich fully operational with redundant photo storage
- Database persistent and backed up automatically
- Seamless integration into Ubuntu VM and TrueNAS storage
- Provides modular foundation for adding additional services in the homelab
