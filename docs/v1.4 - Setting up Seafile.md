# v1.4 â€“ Setting up Seafile

This document provides a detailed walkthrough of the setup and configuration of Seafile, a private file syncing and sharing platform, on the `somaniserver`.

## 1. Introduction

Seafile is a self-hosted file-syncing platform with a focus on privacy and data ownership. It provides features similar to Dropbox or Google Drive, but all data is stored on your own server. In this project, Seafile is used to provide a reliable and secure way to sync files across multiple devices, with all data stored on the redundant ZFS pool.

## 2. Prerequisites

Before installing Seafile, ensure the following prerequisites are met:

*   **Ubuntu VM:** A running Ubuntu VM with Docker and Docker Compose installed.
*   **NFS Share:** The `/mnt/swimming_pool/media` NFS share from the TrueNAS VM must be mounted and accessible on the Ubuntu VM.
*   **User and Group:** The `somaniserver` user (UID 3000) and `somanigroup` group (GID 3001) must exist on the Ubuntu VM and have write permissions to the `/mnt/swimming_pool/media` directory.

## 3. Docker Compose Configuration

Seafile is deployed using Docker Compose. The `docker-compose.yml` file defines the Seafile server and its dependencies.

```yaml
version: '2.0'
services:
  db:
    image: mariadb:10.11
    container_name: seafile-mysql
    environment:
      - MYSQL_ROOT_PASSWORD=secret # Change this
      - MYSQL_LOG_CONSOLE=true
    volumes:
      - /mnt/swimming_pool/media/seafile-mysql:/var/lib/mysql
    networks:
      - seafile-net

  memcached:
    image: memcached:1.6
    container_name: seafile-memcached
    entrypoint: memcached -m 256
    networks:
      - seafile-net

  seafile:
    image: seafileltd/seafile-mc:latest
    container_name: seafile
    ports:
      - "80:80"
    volumes:
      - /mnt/swimming_pool/media/seafile-data:/shared
    environment:
      - DB_HOST=db
      - DB_ROOT_PASSWD=secret # Change this
      - TIME_ZONE=Etc/UTC
      - SEAFILE_ADMIN_EMAIL=admin@example.com # Change this
      - SEAFILE_ADMIN_PASSWORD=secret # Change this
      - SEAFILE_SERVER_LETSENCRYPT=false
      - SEAFILE_SERVER_HOSTNAME=seafile.example.com # Change this
    depends_on:
      - db
      - memcached
    networks:
      - seafile-net

networks:
  seafile-net:
```

**Key points:**

*   **`db` service:** Uses the official MariaDB image as the database for Seafile. The database files are stored in `/mnt/swimming_pool/media/seafile-mysql` to ensure data persistence.
*   **`memcached` service:** Provides a caching layer for Seafile to improve performance.
*   **`seafile` service:** The main Seafile server. It mounts `/mnt/swimming_pool/media/seafile-data` to store user data.
*   **Environment variables:** These are used to configure the Seafile server, including database credentials, admin user, and server hostname. **It is crucial to change the default passwords and email addresses.**

## 4. Systemd Service

To ensure Seafile starts automatically on boot, a `systemd` service is created.

**`/etc/systemd/system/seafile.service`**
```ini
[Unit]
Description=Seafile Service
Requires=network-online.target
After=network-online.target

[Service]
Type=forking
ExecStart=/usr/bin/docker-compose -f /path/to/your/docker-compose.yml up -d
ExecStop=/usr/bin/docker-compose -f /path/to/your/docker-compose.yml down
RemainAfterExit=yes
Restart=always
User=somaniserver
Group=somanigroup

[Install]
WantedBy=multi-user.target
```

**To enable the service:**
```bash
sudo systemctl enable seafile.service
```

## 5. Storage Integration

Seafile's data is stored on the ZFS pool managed by TrueNAS.

*   **`/mnt/swimming_pool/media/seafile-data`:** This directory on the NFS share is mounted into the Seafile container and stores all user files.
*   **`/mnt/swimming_pool/media/seafile-mysql`:** This directory stores the MariaDB database files.

This setup ensures that all of Seafile's data is stored on the redundant ZFS pool, protecting it from single drive failure.

## 6. Verification

To verify that Seafile is working correctly:

1.  **Start the service:** `sudo systemctl start seafile.service`
2.  **Check the container logs:** `docker logs seafile`
3.  **Access the web UI:** Open a web browser and navigate to the IP address of the Ubuntu VM.
4.  **Log in:** Use the admin email and password specified in the `docker-compose.yml` file.
5.  **Upload and download a file:** Test the file syncing functionality.

## 7. Screenshots

*(Please provide the screenshots, and I will add them here with appropriate captions.)*

**[Placeholder for Screenshot 1: Seafile web UI]**
*Caption: The Seafile web interface, showing the file browser.*

**[Placeholder for Screenshot 2: Docker container status]**
*Caption: The output of `docker ps`, showing the running Seafile containers.*

**[Placeholder for Screenshot 3: Systemd service status]**
*Caption: The output of `systemctl status seafile.service`, showing that the service is active and running.*