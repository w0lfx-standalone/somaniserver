# v1.4 â€“ Setting up Seafile

## Objective
- Set up Seafile, a self-hosted file syncing platform, on the Ubuntu Server VM.
- Integrate Seafile with the TrueNAS ZFS pool for persistent and redundant storage.
- Ensure consistent UID/GID mapping for NFS mounts.
- Deploy Seafile and its dependencies (MariaDB and Memcached) using Docker Compose.
- Create a systemd service to manage the Seafile stack automatically.

## Setup Overview
| Component | Details |
|---|---|
| Service Host | Ubuntu Server VM (13GB RAM, 2 vCPU, 110GB disk) |
| Storage Mount | TrueNAS NFS: `/mnt/swimming_pool/media` |
| Containers | Seafile, MariaDB, Memcached |
| UID/GID | 3000:3001 |
| Orchestration | Docker Compose |

## 1. Docker Compose Setup

First, we create a `docker-compose.yml` file to define the Seafile stack. This file includes the Seafile server, a MariaDB database, and a Memcached instance for caching.

**Action:** Create the `docker-compose.yml` file.

```yaml
version: '2.0'
services:
  db:
    image: mariadb:10.11
    container_name: seafile-mysql
    environment:
      - MYSQL_ROOT_PASSWORD=secret # Change this
      - MYSQL_LOG_CONSOLE=true
    volumes:
      - /mnt/swimming_pool/media/seafile-mysql:/var/lib/mysql
    networks:
      - seafile-net

  memcached:
    image: memcached:1.6
    container_name: seafile-memcached
    entrypoint: memcached -m 256
    networks:
      - seafile-net

  seafile:
    image: seafileltd/seafile-mc:latest
    container_name: seafile
    ports:
      - "80:80"
    volumes:
      - /mnt/swimming_pool/media/seafile-data:/shared
    environment:
      - DB_HOST=db
      - DB_ROOT_PASSWD=secret # Change this
      - TIME_ZONE=Etc/UTC
      - SEAFILE_ADMIN_EMAIL=admin@example.com # Change this
      - SEAFILE_ADMIN_PASSWORD=secret # Change this
      - SEAFILE_SERVER_LETSENCRYPT=false
      - SEAFILE_SERVER_HOSTNAME=seafile.example.com # Change this
    depends_on:
      - db
      - memcached
    networks:
      - seafile-net

networks:
  seafile-net:
```

**[Placeholder for Screenshot 1: `docker-compose.yml` file]**
*Caption: The `docker-compose.yml` file for Seafile, showing the service definitions and volume mappings.*

## 2. Systemd Service

Next, we create a `systemd` service to manage the Seafile stack. This will ensure that Seafile starts automatically on boot.

**Action:** Create the `/etc/systemd/system/seafile.service` file.

```ini
[Unit]
Description=Seafile Service
Requires=network-online.target
After=network-online.target

[Service]
Type=forking
ExecStart=/usr/bin/docker-compose -f /path/to/your/docker-compose.yml up -d
ExecStop=/usr/bin/docker-compose -f /path/to/your/docker-compose.yml down
RemainAfterExit=yes
Restart=always
User=somaniserver
Group=somanigroup

[Install]
WantedBy=multi-user.target
```

**[Placeholder for Screenshot 2: `seafile.service` file]**
*Caption: The `seafile.service` file, showing the service definition and commands.*

**Action:** Enable the service.

```bash
sudo systemctl enable seafile.service
```

## 3. Verification

Now, we verify that Seafile is running correctly.

**Action:** Start the service and check its status.

```bash
sudo systemctl start seafile.service
sudo systemctl status seafile.service
```

**[Placeholder for Screenshot 3: `systemctl status seafile.service`]**
*Caption: The output of `systemctl status seafile.service`, showing that the service is active and running.*

**Action:** Check the Docker containers.

```bash
docker ps
```

**[Placeholder for Screenshot 4: `docker ps` output]**
*Caption: The output of `docker ps`, showing the running Seafile containers.*

**Action:** Access the web UI.

Open a web browser and navigate to the IP address of the Ubuntu VM. Log in with the admin credentials defined in the `docker-compose.yml` file.

**[Placeholder for Screenshot 5: Seafile web UI]**
*Caption: The Seafile web interface, showing the file browser after a successful login.*

## 4. Outcome

- Seafile is now fully operational, providing a reliable and private file-syncing solution.
- All data is securely stored on the redundant ZFS mirror, safeguarding against drive failure.
- The server stack now includes both a photo management platform (Immich) and a file-syncing platform (Seafile), creating a comprehensive personal cloud.