# v1.4 – Seafile Setup

## Objective

Set up **Seafile**, a lightweight, high‑performance file syncing platform, on the Ubuntu Server VM — fully integrated with the TrueNAS ZFS pool. The goal of this milestone is to achieve:

* Fast file syncing
* Full data persistence on the ZFS mirror
* Proper UID/GID permission consistency
* Reliable containerized deployment with MariaDB + Memcached

This version mirrors the structure and depth of **v1.3 (Immich Setup)** — clean, technical, and direct.

---

## Setup Overview

### Component | Details

* **Service Host** | Ubuntu Server VM (13GB RAM, 2 vCPU, 110GB disk)
* **Storage Mount** | `/mnt/swimming_pool/seafile` (TrueNAS) → `/mnt/seafile` (Ubuntu)
* **Containers** | Seafile Server, MariaDB, Memcached
* **UID/GID** | 3000:3001
* **Orchestration** | Docker Compose (with restart policies)

Screenshots placeholders:

* TrueNAS dataset view
* Ubuntu mount/ownership
* Docker containers running
* Seafile UI after deployment

---

## Storage & Permissions

### **Dataset on TrueNAS**

Created a dedicated dataset:

```
/mnt/swimming_pool/seafile
```

Applied POSIX permissions:

* **Owner:** UID 3000
* **Group:** GID 3001
* Full RW access

### **Mounting on Ubuntu**

Mounted via NFS at:

```
/mnt/seafile
```

Verified:

```
touch /mnt/seafile/test
ls -l /mnt/seafile
```

Correct ownership: `somaniserver:somanigroup`.

### Why this matters

Same reason as Immich:

* Data persists outside VM
* Survives container/VM reinstalls
* Resilient through ZFS mirror

---

## Docker Deployment

Seafile requires three core services:

* **Seafile Server** (main app)
* **MariaDB** (database)
* **Memcached** (performance caching)

Volumes mapped to:

```
/mnt/seafile/seafile-data
/mnt/seafile/mariadb
/mnt/seafile/config
```

### **Deployment Actions**

* Pulled images for Seafile, MariaDB, Memcached
* Configured `docker-compose.yml` with persistent volumes
* Added restart policies for reliability
* Launched stack using:

```
docker compose up -d
```

* Confirmed all containers started

### **Initial Setup**

Opened:

```
http://<ubuntu-ip>:8082
```

Configured:

* Admin account
* Basic server settings

---

## Verification & Testing

### **File Upload Tests**

* Uploaded files → verified persistence inside ZFS-backed dataset
* Checked UID/GID consistency on all containers and mount paths

### **Sync Test**

* Installed Seafile desktop client
* Synced a test folder → instant reflection on server

### **Restart & Persistence**

* Restarted all containers → no data loss
* Rebooted VM → NFS auto-mounted
* Seafile stack auto-started

### **Database Persistence**

MariaDB mapped to:

```
/mnt/seafile/mariadb
```

Confirmed that DB files remain intact after restarts.

---

## Reliability & Recovery

### **Storage Side (TrueNAS + ZFS)**

* Dataset lives on ZFS mirror → safe from single-disk failure
* Snapshots available for future rollbacks

### **VM Failure Scenario**

If Ubuntu VM is replaced:

1. Remount NFS dataset
2. Recreate UID/GID 3000:3001
3. Run `docker compose up -d`
4. Seafile restores perfectly

### **TrueNAS Reinstallation Scenario**

* Import ZFS pool → dataset + ACLs preserved
* Recreate users/groups → mount again
* No data loss

---

## Outcome

* Seafile fully deployed with persistent storage and redundant backend
* High-speed file syncing available across devices
* Containers isolated and easy to redeploy
* Data stored safely on ZFS mirror via NFS
* Complements Immich (photos) and Nextcloud (heavy suite) without overlapping roles

---

## Version Note

This completes **v1.4 – Seafile Setup**, documented in the same structured and detailed manner as **v1.3**. It establishes Seafile as a dedicated sync service in the `somaniserver` ecosystem, powered by secure and redundant ZFS storage.
